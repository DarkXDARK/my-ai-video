<!-- index.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ูููุฏ ููุฏูู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู</title>
  <script>
  const API_KEY = "key_6ed2397f66edbb1bba927b06e94139079c33d19e81b4e0bc755e913455b83a384815eb1ff4f66245902366e530a0f99db833a76119f216ddca06f1df77ebade6";
  const imgbbApiKey = "c0e2b4b6f8cb952f80d651affe18eda3";

  async function uploadImage() {
    const file = document.getElementById("imageInput").files[0];
    const status = document.getElementById("status");
    const videoDiv = document.getElementById("videoResult");
    const preview = document.getElementById("preview");
    videoDiv.innerHTML = "";
    preview.innerHTML = "";

    if (!file) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ ูุงุญุฏุฉ ููุท.");

    // ุนุฑุถ ุงูุตูุฑุฉ ุงููุฎุชุงุฑุฉ
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement("img");
      img.src = e.target.result;
      img.className = "w-full rounded shadow";
      preview.appendChild(img);
    };
    reader.readAsDataURL(file);

    status.textContent = "๐ค ุฌุงุฑู ุฑูุน ุงูุตูุฑุฉ ุฅูู imgbb...";

    const formData = new FormData();
    formData.append("image", file);

    const uploadRes = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
      method: "POST",
      body: formData
    });

    const uploadData = await uploadRes.json();
    if (!uploadData.success) {
      status.textContent = "โ ูุดู ูู ุฑูุน ุงูุตูุฑุฉ.";
      return;
    }

    const imageUrl = uploadData.data.url;
    status.textContent = "๐ ุฌุงุฑู ุฅุฑุณุงู ุงูุตูุฑุฉ ูู Runway...";

    const runwayRes = await fetch("https://api.runwayml.com/v1/image_to_video", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        promptImage: [
          {
            uri: imageUrl,
            position: "first"
          }
        ],
        ratio: "1280:768",
        fps: 12
      })
    });

    const runwayData = await runwayRes.json();
    if (!runwayData.id) {
      console.error("๐ ุฑุฏ Runway:", runwayData);
      status.textContent = `โ ูุดู ุฅูุดุงุก ุงููููุฉ ูู Runway: ${runwayData.error?.message || "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุนุฑูู."}`;
      return;
    }

    const taskId = runwayData.id;
    status.textContent = "โณ ุฌุงุฑู ุชูููุฏ ุงูููุฏูู...";

    let retries = 20;
    let outputUrl = null;

    while (retries-- > 0) {
      const checkRes = await fetch(`https://api.runwayml.com/v1/tasks/${taskId}`, {
        headers: {
          "Authorization": `Bearer ${API_KEY}`
        }
      });

      const checkData = await checkRes.json();

      if (checkData.status === "SUCCEEDED") {
        outputUrl = checkData.output?.videoUri || checkData.output?.[0]; // ุฏุนู ุงูุดูููู
        break;
      } else if (checkData.status === "FAILED") {
        status.textContent = "โ ูุดู ูู ุฅูุดุงุก ุงูููุฏูู.";
        return;
      }

      await new Promise(r => setTimeout(r, 3000));
    }

    if (outputUrl) {
      status.textContent = "โ ุชู ุฅูุดุงุก ุงูููุฏูู:";
      videoDiv.innerHTML = `
        <video controls class="w-full rounded-md shadow mt-2">
          <source src="${outputUrl}" type="video/mp4">
        </video>
      `;
    } else {
      status.textContent = "โฑ๏ธ ุงูุชูู ุงูููุช ุฏูู ุงูุญุตูู ุนูู ูุชูุฌุฉ.";
    }
  }
</script>
